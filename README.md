# åŸºäºæœºå™¨å­¦ä¹ çš„ç”µæ± ç”µè§£æ¶²æ€§èƒ½é¢„æµ‹ä¸é…æ–¹ä¼˜åŒ–ç³»ç»Ÿ

## 1. é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªç»“åˆææ–™ç§‘å­¦ä¸äººå·¥æ™ºèƒ½æŠ€æœ¯çš„ç ”ç©¶å·¥å…·ï¼Œä¸“æ³¨äºé”‚ç¦»å­ç”µæ± ç”µè§£æ¶²æ€§èƒ½é¢„æµ‹ä¸é…æ–¹ä¼˜åŒ–ã€‚è¯¥é¡¹ç›®åˆ©ç”¨åˆ†å­ç‰¹å¾æå–ã€ææ–™å±æ€§æ ‡å‡†åŒ–å’Œæ·±åº¦å­¦ä¹ æ¨¡å‹ï¼ŒåŸºäºææ–™çš„åŸºç¡€ç‰©æ€§ï¼Œå®ç°ç”µè§£æ¶²æ€§èƒ½çš„ç²¾å‡†é¢„æµ‹ï¼Œä¸ºç”µæ± ç ”å‘æä¾›é«˜æ•ˆçš„è®¡ç®—è¾…åŠ©å·¥å…·ã€‚

### åŠŸèƒ½ç‰¹ç‚¹

- **ç”µè§£æ¶²ææ–™åº“**
  - æ”¯æŒé”‚ç›ã€æº¶å‰‚ã€æ·»åŠ å‰‚ä¸‰å¤§ç±»ææ–™ç®¡ç†
  - åŸºäºRDKitçš„åˆ†å­ç»“æ„ç‰¹å¾è‡ªåŠ¨æå–
  - ææ–™å±æ€§æ ‡å‡†åŒ–å’ŒèŒƒå›´é™åˆ¶
  - å†…ç½®æ•°æ®åº“åŒ…å«å¸¸ç”¨ç”µè§£æ¶²ææ–™ç‰©æ€§æ•°æ®
- **ç”µè§£æ¶²é…æ–¹ç³»ç»Ÿ**
  - çµæ´»çš„ç»„åˆ†é…æ¯”å’Œææ–™ç»„åˆ
  - åŸºäºå æ¯”çš„é…æ–¹ç‰¹å¾å‘é‡ç”Ÿæˆ
  - é…æ–¹åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ”¯æŒ
- **ç”µè§£æ¶²æ€§èƒ½é¢„æµ‹**
  - åŸºäºTransformeræ¶æ„çš„ç”µè§£æ¶²ç”µå¯¼ç‡ã€ç²˜åº¦é¢„æµ‹
  - èåˆåˆ†å­æŒ‡çº¹ã€ç‰©ç†åŒ–å­¦æ€§è´¨çš„å¤šæ¨¡æ€ç‰¹å¾å­¦ä¹ 
  - è®­ç»ƒ-éªŒè¯-æµ‹è¯•å®Œæ•´è¯„ä¼°æµç¨‹
- **ç”µæ± æ•´ä½“æ€§èƒ½é¢„æµ‹**
  - å¯æ‰©å±•åˆ†æç”µæ± æ­£è´Ÿæææ–™
  - ç»¼åˆç”µè§£æ¶²é…æ–¹ã€æ­£è´Ÿæææ–™å¯¹ç”µæ± æ•´ä½“æ€§èƒ½è¿›è¡Œé¢„æµ‹
  - å®ç°é€šè¿‡ææ–™ç‰©æ€§ç›´æ¥é¢„æµ‹ç”µæ± æ•´ä½“æ€§èƒ½
- **å¯è§†åŒ–ä¸åˆ†æ**
  - é…æ–¹æ€§èƒ½æ¯”è¾ƒä¸åˆ†æ
  - ç»“æ„-æ€§èƒ½å…³ç³»å¯è§†åŒ–
  - å®éªŒæ•°æ®ä¸é¢„æµ‹ç»“æœå¯¹æ¯”

### æŠ€æœ¯å®ç°

- **ææ–™è¡¨ç¤º**: ä½¿ç”¨MACCSåˆ†å­æŒ‡çº¹å’Œç‰©ç†åŒ–å­¦æ€§è´¨
- **å†…å­˜ä¼˜åŒ–**: é‡‡ç”¨å¯¹è±¡æ± æ¨¡å¼é¿å…é‡å¤ææ–™å®ä¾‹
- **æ¨¡å‹æ¶æ„**: åŸºäºTransformerçš„åºåˆ—ç‰¹å¾å­¦ä¹ 
- **æ•°æ®éªŒè¯**: ä½¿ç”¨Pydanticè¿›è¡Œä¸¥æ ¼çš„æ•°æ®ç±»å‹æ£€æŸ¥
- **æ¨¡å—è§£è€¦**ï¼šå¯¹ç”µæ± -ç”µè§£æ¶²-ææ–™ä¸‰éƒ¨åˆ†è¿›è¡Œè§£è€¦

## 2. å®‰è£…æŒ‡å—

### ç¯å¢ƒè¦æ±‚

- Python 3.12+
- PyTorch 1.8+
- RDKit
- Pydantic 2.0+

### å®‰è£…æ­¥éª¤

**ä½¿ç”¨ `uv` (æ¨è):**

```bash
# uv æ˜¯ä¸€ä¸ªæé€Ÿçš„ Python åŒ…å®‰è£…å’Œè§£æå™¨
# https://docs.astral.sh/uv/getting-started/installation/
uv sync
```

**ä½¿ç”¨ `pip`:**
```bash
pip install -e .
```

## 3. é¡¹ç›®ç»“æ„ä¸æ¨¡å—åŠŸèƒ½

é¡¹ç›®é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œå„ä¸»è¦æ–‡ä»¶å¤¹åŠŸèƒ½å¦‚ä¸‹ï¼š

```
ElectrolyteML/
â”œâ”€â”€ battery/         # æ ¸å¿ƒ: å®šä¹‰ç”µæ± ã€ç”µè§£æ¶²ç­‰æ•°æ®ç»“æ„å’Œè¡Œä¸º
â”œâ”€â”€ material/        # æ ¸å¿ƒ: ç®¡ç†ææ–™åº“ï¼ˆç›ã€æº¶å‰‚ã€æ·»åŠ å‰‚ï¼‰
â”œâ”€â”€ dataset/         # æ ¸å¿ƒ: è´Ÿè´£æ•°æ®é›†åŠ è½½ã€æ¨¡å‹è®­ç»ƒå’Œæ€§èƒ½é¢„æµ‹
â”œâ”€â”€ ml/              # æ ¸å¿ƒ: å®šä¹‰æœºå™¨å­¦ä¹ æ¨¡å‹ï¼ˆå¦‚ Transformerï¼‰
â”œâ”€â”€ data/            # è¾…åŠ©: å­˜æ”¾åŸå§‹æ•°æ®æ–‡ä»¶ï¼ˆ.csv, .jsonï¼‰
â”œâ”€â”€ config/          # è¾…åŠ©: é¡¹ç›®é…ç½®æ–‡ä»¶
â”œâ”€â”€ tools/           # è¾…åŠ©: æ•°æ®å¤„ç†ç­‰å·¥å…·è„šæœ¬
â””â”€â”€ utils/           # è¾…åŠ©: é€šç”¨è¾…åŠ©å‡½æ•°
```

---

## 4. æ ¸å¿ƒæ¨¡å—ä½¿ç”¨è¯´æ˜

ä»¥ä¸‹æ˜¯å„æ ¸å¿ƒæ¨¡å—çš„è¯¦ç»†åŠŸèƒ½å’Œä½¿ç”¨ç¤ºä¾‹ã€‚

### `material`: ææ–™åº“ç®¡ç†

**åŠŸèƒ½**:
æ­¤æ¨¡å—è´Ÿè´£åŠ è½½å’Œç®¡ç†æ‰€æœ‰åŒ–å­¦ææ–™ï¼ˆé”‚ç›ã€æº¶å‰‚ã€æ·»åŠ å‰‚ï¼‰ã€‚å®ƒä» `materials.json` æ–‡ä»¶ä¸­è¯»å–ææ–™çš„åŸºç¡€ç‰©ç†åŒ–å­¦æ€§è´¨ï¼Œå¹¶æä¾›ä¸€ä¸ªå…¨å±€å®ä¾‹ `MLibrary` æ–¹ä¾¿åœ¨é¡¹ç›®ä¸­éšæ—¶è°ƒç”¨ã€‚

**å…³é”®ç»„ä»¶**:
- `Material`: å•ä¸ªææ–™çš„åŸºç±»ã€‚
- `MaterialLibrary`: ææ–™æ•°æ®åº“ï¼Œè´Ÿè´£åŠ è½½ã€æŸ¥è¯¢å’Œç®¡ç†æ‰€æœ‰ææ–™ã€‚
- `MLibrary`: `MaterialLibrary` çš„ä¸€ä¸ªå…¨å±€å•ä¾‹ï¼Œé¢„åŠ è½½äº†æ‰€æœ‰ææ–™æ•°æ®ï¼Œä¾›é¡¹ç›®å…¨å±€è°ƒç”¨ã€‚

**ä½¿ç”¨ç¤ºä¾‹**:

```python
from elml import MLibrary

# MLibrary å·²è‡ªåŠ¨åŠ è½½ 'data/materials.json' ä¸­çš„æ•°æ®
print(f"ææ–™åº“åŠ è½½å®Œæˆï¼Œå…± {len(MLibrary)} ç§ææ–™ã€‚")

# 1. åˆ¤æ–­ææ–™æ˜¯å¦å­˜åœ¨æ•°æ®åº“ä¸­
MLibrary.has_material("LiPF6")  # é”‚ç›LiPF6
>>> True
MLibrary.has_material(cas_registry_number="96-49-1")  # æº¶å‰‚EC
>>> True
MLibrary.has_material(abbr="LiPF6", cas_registry_number="96-49-1")  # ææ–™ç¼©å†™ä¸CASå·ä¸åŒ¹é…
>>> False

# 2. é€šè¿‡ææ–™ç¼©å†™ (abbr) è·å–ææ–™
lipf6 = MLibrary.get_material("LiPF6")
print(f"è·å–ææ–™: {lipf6.name}, CASå·: {lipf6.cas_registry_number}")

# 3. é€šè¿‡ CAS æ³¨å†Œå·è·å–ææ–™
ec = MLibrary.get_material(cas_registry_number="96-49-1")
print(f"è·å–ææ–™: {ec.name}, åˆ†å­é‡: {ec.molecular_weight}")

# 4. æŸ¥çœ‹ææ–™å±æ€§
print(f"EC çš„ä»‹ç”µå¸¸æ•°: {ec.dielectric_constant}")
print(f"LiPF6 çš„å¯†åº¦: {lipf6.density} g/cmÂ³")
```

### `battery`: ç”µè§£æ¶²ä¸ç”µæ± å®šä¹‰

**åŠŸèƒ½**:
æ­¤æ¨¡å—ç”¨äºå®šä¹‰ç”µè§£æ¶²é…æ–¹å’Œå®Œæ•´çš„ç”µæ± ç»“æ„ã€‚`Electrolyte` ç±»æ˜¯æ ¸å¿ƒï¼Œå®ƒä½¿ç”¨ `material` æ¨¡å—ä¸­çš„ææ–™æ¥æ„å»ºå…·æœ‰ç‰¹å®šç»„åˆ†å’Œæ¯”ä¾‹çš„ç”µè§£æ¶²ã€‚

**å…³é”®ç»„ä»¶**:
- `Component`: è¡¨ç¤ºé…æ–¹ä¸­çš„ä¸€ä¸ªç»„åˆ†ï¼ˆå¦‚ç‰¹å®šæ¯”ä¾‹çš„æº¶å‰‚ï¼‰ã€‚
- `Electrolyte`: æ ¸å¿ƒç±»ï¼Œç”±å¤šä¸ª `Component` ç»„æˆï¼Œä»£è¡¨ä¸€ä¸ªå®Œæ•´çš„ç”µè§£æ¶²é…æ–¹ã€‚
- `Battery`: ï¼ˆå¯æ‰©å±•ï¼‰ç”¨äºé›†æˆç”µè§£æ¶²ã€æ­£æå’Œè´Ÿæï¼Œä»¥è¿›è¡Œæ›´å…¨é¢çš„ç”µæ± æ€§èƒ½åˆ†æã€‚

**ä½¿ç”¨ç¤ºä¾‹**:

```python
from elml import MLibrary
from elml.battery import Electrolyte

lipf6 = MLibrary.get_material(abbr="LiPF6")
ec = MLibrary.get_material(abbr="EC")
dmc = MLibrary.get_material(abbr="DMC")

# 1. ä½¿ç”¨ Electrolyte.create() æ–¹æ³•è½»æ¾åˆ›å»ºæ–°é…æ–¹
lp30_recipe = Electrolyte.create(
    name="LP30",
    id="standard-lp30",
    description="ä¸€ä¸ªæ ‡å‡†çš„ LiPF6 åœ¨ EC/DMC ä¸­çš„ç”µè§£æ¶²é…æ–¹",
    salts=[(lipf6, 10.0)],  #  å¯¹äºç›ï¼Œoverall_fraction æ˜¯å…¶åœ¨æ€»æº¶å‰‚è´¨é‡ä¸­çš„é‡é‡ç™¾åˆ†æ¯”
    solvents=[
        (ec, 50.0),
        (dmc, 50.0),
    ],  # å¯¹äºæº¶å‰‚ï¼Œrelative_fraction æ˜¯å…¶åœ¨æ‰€æœ‰æº¶å‰‚ä¸­çš„ç›¸å¯¹ä½“ç§¯æˆ–é‡é‡æ¯”
    additives=[],  # ä¹Ÿå¯ä»¥æ·»åŠ æ·»åŠ å‰‚
    performance={},
)

# 2. æ˜¾ç¤ºé…æ–¹è¯¦æƒ…
lp30_recipe.show()

# 3. è®¿é—®é…æ–¹ç»„åˆ†
print(f"é…æ–¹ '{lp30_recipe.name}' çš„ç›: {lp30_recipe.salts[0].name}")

```

### `dataset`: æ•°æ®é›†ä¸æ¨¡å‹è®­ç»ƒ

**åŠŸèƒ½**:
è¿™æ˜¯æ‰§è¡Œæœºå™¨å­¦ä¹ ä»»åŠ¡çš„å…¥å£ã€‚å®ƒè´Ÿè´£åŠ è½½ç”µè§£æ¶²æ•°æ®é›†ï¼ˆåŒ…å«é…æ–¹å’Œå¯¹åº”çš„å®éªŒæ€§èƒ½ï¼‰ï¼Œå¤„ç†æ•°æ®ï¼Œè®­ç»ƒæ¨¡å‹ï¼Œå¹¶ä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹è¿›è¡Œæ€§èƒ½é¢„æµ‹ã€‚

**å…³é”®ç»„ä»¶**:
- `ElectrolyteDataset`: æ ¸å¿ƒç±»ï¼Œå°è£…äº†æ•°æ®åŠ è½½ã€é¢„å¤„ç†ã€æ¨¡å‹è®­ç»ƒå’Œé¢„æµ‹çš„æ‰€æœ‰åŠŸèƒ½ã€‚

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from elml.dataset import ElectrolyteDataset
from elml.battery import Electrolyte  # ç”¨äºåˆ›å»ºå¾…é¢„æµ‹çš„é…æ–¹

# 1. åŠ è½½ä¸€ä¸ªç”µè§£æ¶²æ•°æ®é›†ï¼ˆä¾‹å¦‚ï¼ŒåŒ…å«å¤šä¸ªé…æ–¹åŠå…¶ç”µå¯¼ç‡ï¼‰
dataset = ElectrolyteDataset("data/calisol23.json")
print(f"æ•°æ®é›†åŠ è½½æˆåŠŸï¼ŒåŒ…å« {len(dataset)} ä¸ªç”µè§£æ¶²æ ·æœ¬ã€‚")

# 2. æŒ‰è¦æ±‚åˆ’åˆ†è®­ç»ƒé›†ï¼ŒéªŒè¯é›†ï¼Œæµ‹è¯•é›†
train_dataset, val_dataset, test_dataset = ElectrolyteDataset.create_splits(
    dataset_file="data/calisol23/calisol23.json",
    target_metric="conductivity",
    train_frac=0.7,
    val_frac=0.2,
    random_seed=42,
)

# 3. è®­ç»ƒä¸€ä¸ªæ€§èƒ½é¢„æµ‹æ¨¡å‹
#    æ¨¡å‹å¯ä»¥æ˜¯ 'transformer' æˆ– 'mlp'
history = dataset.train_model(
    model="transformer",
    model_config={
        "hidden_dim": 128,
        "n_layers": 2,
        "n_heads": 2,
    },  # Transformerç‰¹å®šå‚æ•°
    epochs=50,  # è®­ç»ƒè½®æ¬¡
    save_path="models/best_conductivity_model.pth",  # ä¿å­˜æœ€ä½³æ¨¡å‹
)
print("æ¨¡å‹è®­ç»ƒå®Œæˆï¼")
```

### `ml`: æœºå™¨å­¦ä¹ æ¨¡å‹å®šä¹‰

**åŠŸèƒ½**:
æ­¤æ¨¡å—åŒ…å«äº†ç”¨äºæ€§èƒ½é¢„æµ‹çš„ç¥ç»ç½‘ç»œæ¨¡å‹çš„å…·ä½“å®ç°ï¼ˆåŸºäº PyTorchï¼‰ã€‚è¿™äº›æ¨¡å‹é€šå¸¸ä¸æ˜¯ç›´æ¥ä½¿ç”¨çš„ï¼Œè€Œæ˜¯ç”± `ElectrolyteDataset` åœ¨ `train_model` æ–¹æ³•å†…éƒ¨è°ƒç”¨ã€‚

**å…³é”®ç»„ä»¶**:
- `ElectrolyteTransformer`: åŸºäº Transformer æ¶æ„çš„æ¨¡å‹ï¼Œæ“…é•¿æ•æ‰åºåˆ—ç‰¹å¾ã€‚
- `ElectrolyteMLP`: ä¸€ä¸ªæ ‡å‡†çš„å¤šå±‚æ„ŸçŸ¥å™¨ï¼ˆMLPï¼‰æ¨¡å‹ã€‚

**ä½¿ç”¨è¯´æ˜**:
æ‚¨å¯ä»¥åœ¨è°ƒç”¨ `dataset.train_model` æ—¶ï¼Œé€šè¿‡ `model` å’Œ `model_config` å‚æ•°æ¥é€‰æ‹©å’Œé…ç½®è¿™äº›æ¨¡å‹ã€‚å¦‚æœæ‚¨æƒ³å®ç°æ–°çš„æ¨¡å‹æ¶æ„ï¼Œå¯ä»¥åœ¨æ­¤æ–‡ä»¶å¤¹ä¸‹æ·»åŠ æ–°çš„æ¨¡å‹ç±»ã€‚

---

## 5. ç«¯åˆ°ç«¯å·¥ä½œæµç¤ºä¾‹

è¿™ä¸ªä¾‹å­å°†å±•ç¤ºå¦‚ä½•ä»é›¶å¼€å§‹ï¼Œç»“åˆæ‰€æœ‰æ¨¡å—ï¼Œå®Œæˆä¸€ä¸ªå…¸å‹çš„ä»»åŠ¡ï¼š**åˆ›å»ºä¸€ä¸ªæ–°çš„ç”µè§£æ¶²é…æ–¹ï¼Œå¹¶ä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹é¢„æµ‹å…¶ç¦»å­ç”µå¯¼ç‡**ã€‚

```python
import torch
from elml.material import MLibrary
from elml.battery import Electrolyte
from elml.dataset import ElectrolyteDataset

# --- æ­¥éª¤ 1: åˆå§‹åŒ–ç¯å¢ƒ ---
# åŠ è½½ææ–™åº“ (ç”± material æ¨¡å—è‡ªåŠ¨å®Œæˆ)
print(f"âœ… 1. ææ–™åº“å·²åŠ è½½ï¼Œå…± {len(MLibrary)} ç§ææ–™ã€‚")

# --- æ­¥éª¤ 2: åˆ›å»ºä¸€ä¸ªæ–°çš„ç”µè§£æ¶²é…æ–¹ ---
# å‡è®¾æˆ‘ä»¬è¦è®¾è®¡ä¸€ä¸ªé«˜æµ“åº¦ç”µè§£æ¶²
lipf6 = MLibrary.get_material(abbr="LiPF6")
ec = MLibrary.get_material(abbr="EC")
dmc = MLibrary.get_material(abbr="DMC")
vc = MLibrary.get_material(abbr="VC")

my_new_recipe = Electrolyte.create(
    name="My-Custom-High-Concentration-Electrolyte",
    id="Custom-1",
    description="A custom electrolyte with high concentration of LiPF6 and specific solvent ratios.",
    salts=[(lipf6, 15.0)],  # ç›æµ“åº¦æé«˜åˆ° 15%
    solvents=[
        (ec, 40.0),
        (dmc, 60.0),
    ],
    additives=[(vc, 2.0)],  # æ·»åŠ  2% çš„ VC æ·»åŠ å‰‚
    performance={
        "ionic_conductivity": 12.0,
        "viscosity": 5.0,
        "electrochemical_window": 4.5,
        "thermal_stability": 80.0,
    },
)
print(f"âœ… 2. å·²åˆ›å»ºæ–°é…æ–¹: '{my_new_recipe.name}'")
my_new_recipe.show()



# --- æ­¥éª¤ 3: åŠ è½½æ•°æ®é›†å¹¶è®­ç»ƒæ¨¡å‹ ---
# ä½¿ç”¨ calisol23 æ•°æ®é›†è¿›è¡Œè®­ç»ƒ
dataset = ElectrolyteDataset("data/calisol23.json")

print("
âœ… 3. å¼€å§‹è®­ç»ƒæ€§èƒ½é¢„æµ‹æ¨¡å‹...")
dataset.train_model(
    model="transformer",
    model_config={"hidden_dim": 256, "n_layers": 2, "n_heads": 4},
    epochs=100, # å®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦æ›´å¤šè½®æ¬¡
    learning_rate=0.001,
    save_path="models/best_model.pth"
)
print("æ¨¡å‹è®­ç»ƒå®Œæ¯•ï¼")


# --- æ­¥éª¤ 4: é¢„æµ‹æ–°é…æ–¹çš„æ€§èƒ½ ---
# ä½¿ç”¨åˆšåˆšè®­ç»ƒå¥½çš„æ¨¡å‹è¿›è¡Œé¢„æµ‹
print(f"
âœ… 4. é¢„æµ‹æ–°é…æ–¹ '{my_new_recipe.name}' çš„æ€§èƒ½...")
predicted_performance = dataset.predict(my_new_recipe)

print("
" + "="*50)
print(f"ğŸ‰ é¢„æµ‹ç»“æœ ğŸ‰")
print(f"é…æ–¹: {my_new_recipe.name}")
print(f"é¢„æµ‹çš„ç¦»å­ç”µå¯¼ç‡: {predicted_performance:.4f} mS/cm")
print("="*50)

```
